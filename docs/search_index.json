[["index.html", "MAIDHA | Very detailed examples 1 About", " MAIDHA | Very detailed examples H. Colineaux Last compiled on 17 January, 2025 1 About Disclaimer: Here, I’m not going back over the theory and concepts involved in intersectional quantative analysis and MAIDHA models. This is simply a sharing of scripts to simplify the implementation of this type of analysis in epidemiology. We were largely inspired by the work of Evans et al (for example: Evans et al. (2024)) and the vignette in the [ggeffects]:https://strengejacke.github.io/ggeffects/articles/practical_intersectionality.html package. The online version of this book is licensed under the Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License. "],["create-stratas.html", "2 Create stratas 2.1 Choose variables 2.2 Definition and description 2.3 Create strata variables 2.4 Plots the stratas distribution", " 2 Create stratas 2.1 Choose variables For the first example, we use real data from the UKBB. This is an exploratory and not a confirmatory analysis, the results are purely didactic and cannot be really interpreted. In particular, for simplicity, a simple imputation of missing data (KNN) has been carried out, which may affect the results. 2.1.1 A first simple exemple (12 strata) To define strata, we choose the following variables: age, by classes: “-50,” “51-60,” “61+” declared binary sex category: men or women, ethnicity: white or non-white. Outcomes will be later intersectional categories, i.e.  age at the end of education (quantitative variables) life place: urban or rural (qualitative variable). There are no variables characterizing socio-economic position at the start of life in this dataset, such as parent social class or income. 2.1.2 A second exemple (48 strata) In a second step, we use to define intersectional strata: age, by classes: “-50,” “51-60,” “61+” declared binary sex category: men or women, ethnicity: white or non-white. education: end at 16 or before, end at 17 or after life place: urban or rural The outcomes were: drinking alcohol daily (binary outcomes) exposition to air pollution (pm10, ugm3). 2.2 Definition and description mydata$Sex &lt;- factor(round(mydata$Sex), labels = c(&quot;Women&quot;,&quot;Men&quot;)) mydata$Ethnicity &lt;- factor(round(mydata$Ethnicity), label = c(&quot;Non White&quot;,&quot;White&quot;)) mydata &lt;- mydata %&gt;% # recode age into three groups mutate(Age_class = round(Age)) %&gt;% recode_values( select = &quot;Age_class&quot;, recode = list(`1` = &quot;min:50&quot;, `2` = 51:60, `3` = &quot;61:max&quot;)) %&gt;% mutate(Age_class = factor(Age_class, labels = c(&quot;-50&quot;, &quot;51-60&quot;, &quot;61+&quot;))) mydata$Urban &lt;- factor(round(mydata$Urban), labels = c(&quot;Rural&quot;, &quot;Urban&quot;)) mydata &lt;- mydata %&gt;% # recode age into three groups mutate(Education = round(AgeEducEnd)) %&gt;% recode_values( select = &quot;Education&quot;, recode = list(`0` = &quot;min:16&quot;, `1` = &quot;17:max&quot;)) %&gt;% mutate(Education = factor(Education, labels = c(&quot;Short Educ.&quot;, &quot;Long Educ.&quot;))) mydata$AlcDaily &lt;- factor(round(mydata$AlcDaily), labels = c(&quot;No&quot;, &quot;Yes&quot;)) table1::table1(~ Sex + Age + Ethnicity + AgeEducEnd + Education + Urban + AlcDaily + AirPoll_PM10, data=mydata, overall=c(left=&quot;Total&quot;), caption=&quot;Description&quot;) Description Total(N=502461) Sex Women 273354 (54.4%) Men 229107 (45.6%) Age Mean (SD) 56.5 (8.10) Median [Min, Max] 58.0 [37.0, 73.0] Ethnicity Non White 27037 (5.4%) White 475424 (94.6%) AgeEducEnd Mean (SD) 16.8 (1.98) Median [Min, Max] 16.1 [5.00, 35.0] Education Short Educ. 284626 (56.6%) Long Educ. 217835 (43.4%) Urban Rural 68955 (13.7%) Urban 433506 (86.3%) AlcDaily No 400687 (79.7%) Yes 101774 (20.3%) AirPoll_PM10 Mean (SD) 16.2 (1.86) Median [Min, Max] 16.1 [11.8, 31.4] 2.3 Create strata variables 2.3.1 For the first exemple (12 strata) To create the stratas, I use the method describe in the vignette in the [ggeffects]:https://strengejacke.github.io/ggeffects/articles/practical_intersectionality.html package. This involves concatenating the labels of the different variables. Remember to name the variable in the label, for example Ethnicity[White;Non White] rather than White[Yes;No]. mydata$strata &lt;- ifelse( is.na(mydata$Sex) | is.na(mydata$Ethnicity) | is.na(mydata$Age_class), NA_character_, paste0(mydata$Sex, &quot;, &quot;, mydata$Ethnicity, &quot;, &quot;, mydata$Age_class) ) mydata$strata &lt;- factor(mydata$strata) We have 12 stratas # data_tabulate(mydata$strata) table1::table1(~ strata, data=mydata, overall=c(left=&quot;Total&quot;), caption=&quot;Stratas (12)&quot;) Stratas (12) Total(N=502461) strata Men, Non White, -50 5749 (1.1%) Men, Non White, 51-60 3856 (0.8%) Men, Non White, 61+ 2754 (0.5%) Men, White, -50 53729 (10.7%) Men, White, 51-60 73877 (14.7%) Men, White, 61+ 89142 (17.7%) Women, Non White, -50 6652 (1.3%) Women, Non White, 51-60 5149 (1.0%) Women, Non White, 61+ 2877 (0.6%) Women, White, -50 66015 (13.1%) Women, White, 51-60 94340 (18.8%) Women, White, 61+ 98321 (19.6%) 2.3.2 For the second exemple (48 strata) And with more categories: mydata$strata_2 &lt;- ifelse( is.na(mydata$Sex) | is.na(mydata$Ethnicity) | is.na(mydata$Age_class) | is.na(mydata$Education) | is.na(mydata$Urban), NA_character_, paste0(mydata$Sex, &quot;, &quot;, mydata$Ethnicity, &quot;, &quot;, mydata$Age_class,&quot;, &quot;, mydata$Education,&quot;, &quot;, mydata$Urban) ) We have 48 stratas mydata$strata_2 &lt;- factor(mydata$strata_2) table1::table1(~ strata_2, data=mydata, overall=c(left=&quot;Total&quot;), caption=&quot;Stratas (48)&quot;) Stratas (48) Total(N=502461) strata_2 Men, Non White, -50, Long Educ., Rural 90 (0.0%) Men, Non White, -50, Long Educ., Urban 3432 (0.7%) Men, Non White, -50, Short Educ., Rural 44 (0.0%) Men, Non White, -50, Short Educ., Urban 2183 (0.4%) Men, Non White, 51-60, Long Educ., Rural 71 (0.0%) Men, Non White, 51-60, Long Educ., Urban 2217 (0.4%) Men, Non White, 51-60, Short Educ., Rural 49 (0.0%) Men, Non White, 51-60, Short Educ., Urban 1519 (0.3%) Men, Non White, 61+, Long Educ., Rural 54 (0.0%) Men, Non White, 61+, Long Educ., Urban 1523 (0.3%) Men, Non White, 61+, Short Educ., Rural 36 (0.0%) Men, Non White, 61+, Short Educ., Urban 1141 (0.2%) Men, White, -50, Long Educ., Rural 3453 (0.7%) Men, White, -50, Long Educ., Urban 22408 (4.5%) Men, White, -50, Short Educ., Rural 3118 (0.6%) Men, White, -50, Short Educ., Urban 24750 (4.9%) Men, White, 51-60, Long Educ., Rural 5121 (1.0%) Men, White, 51-60, Long Educ., Urban 27890 (5.6%) Men, White, 51-60, Short Educ., Rural 5220 (1.0%) Men, White, 51-60, Short Educ., Urban 35646 (7.1%) Men, White, 61+, Long Educ., Rural 5939 (1.2%) Men, White, 61+, Long Educ., Urban 25643 (5.1%) Men, White, 61+, Short Educ., Rural 7868 (1.6%) Men, White, 61+, Short Educ., Urban 49692 (9.9%) Women, Non White, -50, Long Educ., Rural 137 (0.0%) Women, Non White, -50, Long Educ., Urban 3949 (0.8%) Women, Non White, -50, Short Educ., Rural 66 (0.0%) Women, Non White, -50, Short Educ., Urban 2500 (0.5%) Women, Non White, 51-60, Long Educ., Rural 101 (0.0%) Women, Non White, 51-60, Long Educ., Urban 2931 (0.6%) Women, Non White, 51-60, Short Educ., Rural 58 (0.0%) Women, Non White, 51-60, Short Educ., Urban 2059 (0.4%) Women, Non White, 61+, Long Educ., Rural 54 (0.0%) Women, Non White, 61+, Long Educ., Urban 1561 (0.3%) Women, Non White, 61+, Short Educ., Rural 35 (0.0%) Women, Non White, 61+, Short Educ., Urban 1227 (0.2%) Women, White, -50, Long Educ., Rural 4914 (1.0%) Women, White, -50, Long Educ., Urban 29922 (6.0%) Women, White, -50, Short Educ., Rural 3626 (0.7%) Women, White, -50, Short Educ., Urban 27553 (5.5%) Women, White, 51-60, Long Educ., Rural 7112 (1.4%) Women, White, 51-60, Long Educ., Urban 35356 (7.0%) Women, White, 51-60, Short Educ., Rural 6709 (1.3%) Women, White, 51-60, Short Educ., Urban 45163 (9.0%) Women, White, 61+, Long Educ., Rural 6210 (1.2%) Women, White, 61+, Long Educ., Urban 27747 (5.5%) Women, White, 61+, Short Educ., Rural 8870 (1.8%) Women, White, 61+, Short Educ., Urban 55494 (11.0%) In this case, some stratas are very small. tab &lt;- data_tabulate(mydata$strata_2) tab &lt;- tab[1:48,] min(tab$N) ## [1] 35 max(tab$N) ## [1] 55494 2.4 Plots the stratas distribution 2.4.1 For the first exemple df &lt;- data.frame(x = names(table(mydata$strata)), p = as.numeric(table(mydata$strata))/length(mydata$strata), n = as.numeric(table(mydata$strata))) df$sex = as.factor(ifelse(grepl(&quot;Men&quot;, df$x), &quot;Men&quot;, &quot;Women&quot;)) df$ethnicity &lt;- as.factor(ifelse(grepl(&quot;Non White&quot;, df$x), &quot;Non White&quot;, &quot;White&quot;)) df$age &lt;- as.factor(ifelse(grepl(&quot;61+&quot;, df$x), &quot;61+&quot;, ifelse(grepl(&quot;-50&quot;, df$x), &quot;-50&quot;,&quot;51-60&quot;))) jpeg(&quot;img/plot_stata_1.jpeg&quot;, width = 800, height = &quot;500&quot;) ggplot(data = df) + geom_col(aes(x = fct_reorder(x,n,.fun=&#39;median&#39;), y = n, linewidth = age, fill = ethnicity), color = &quot;black&quot;) + geom_point(aes(x = fct_reorder(x,n,.fun=&#39;median&#39;), y = n, color = sex), size =4) + theme(plot.margin = margin(1,1,1.5,2, &quot;cm&quot;))+ labs (x=&quot;&quot;, y = &quot;N&quot;, fill = &quot;Ethnicity&quot;) + theme(axis.text.x = element_text(angle = 45, vjust=1, hjust=1))+ scale_linewidth_discrete(range = c(0.5, 1))+ # scale_y_log10() scale_y_continuous(breaks = c(1000, 10000, 25000,50000, 75000))+ scale_shape_manual(values=c(19, 15)) dev.off() ## png ## 2 2.4.2 For the second exemple df_2 &lt;- data.frame(x = names(table(mydata$strata_2)), p = as.numeric(table(mydata$strata_2))/length(mydata$strata_2), n = as.numeric(table(mydata$strata_2))) df_2$sex = as.factor(ifelse(grepl(&quot;Men&quot;, df_2$x), &quot;Men&quot;, &quot;Women&quot;)) df_2$ethnicity &lt;- as.factor(ifelse(grepl(&quot;Non White&quot;, df_2$x), &quot;Non White&quot;, &quot;White&quot;)) df_2$age &lt;- as.factor(ifelse(grepl(&quot;61+&quot;, df_2$x), &quot;61+&quot;, ifelse(grepl(&quot;-50&quot;, df_2$x), &quot;-50&quot;,&quot;51-60&quot;))) df_2$Education &lt;- as.factor(ifelse(grepl(&quot;Short&quot;, df_2$x), &quot;Short&quot;, &quot;Long&quot;)) df_2$LocalArea &lt;- as.factor(ifelse(grepl(&quot;Urban&quot;, df_2$x), &quot;Urban&quot;, &quot;Rural&quot;)) jpeg(&quot;img/plot_stata_2.jpeg&quot;, width = 1200, height = &quot;800&quot;) ggplot(data = df_2) + geom_col(aes(x = fct_reorder(x,n,.fun=&#39;median&#39;), y = n, linewidth = age, fill = ethnicity, alpha = LocalArea), color = &quot;black&quot;) + geom_point(aes(x = fct_reorder(x,n,.fun=&#39;median&#39;), y = n, shape = Education, color = sex), size =4) + theme(plot.margin = margin(1,1,1.5,2, &quot;cm&quot;))+ labs (x=&quot;&quot;, y = &quot;N&quot;, fill = &quot;Ethnicity&quot;) + theme(axis.text.x = element_text(angle = 45, vjust=1, hjust=1))+ scale_alpha_discrete(range = c(0.5, 1))+ scale_linewidth_discrete(range = c(0.5, 1))+ # scale_y_log10() scale_y_continuous(breaks = c(1000, 10000, 20000,30000,40000,50000))+ scale_shape_manual(values=c(19, 15)) dev.off() ## png ## 2 "],["simple-example---binary-outcome.html", "3 Simple example - binary outcome 3.1 Description 3.2 The null model (only strata) 3.3 The variance change", " 3 Simple example - binary outcome As a working example, we want to explore intersectional inequalities in life place (a “late” intersectional strata) by early intersectional strata (12 stratas). 3.1 Description We can start by describe the outcome by strata. table1::table1(~ Sex + Age_class + Ethnicity | Urban, data=mydata, row_wise = TRUE, overall=c(left=&quot;Total&quot;), caption=&quot;Description by life place&quot;) Description by life place Total(N=502461) Rural(N=68955) Urban(N=433506) Sex Women 273354 (54.4%) 37892 (55.0%) 235462 (54.3%) Men 229107 (45.6%) 31063 (45.0%) 198044 (45.7%) Age_class -50 132145 (26.3%) 15448 (22.4%) 116697 (26.9%) 51-60 177222 (35.3%) 24441 (35.4%) 152781 (35.2%) 61+ 193094 (38.4%) 29066 (42.2%) 164028 (37.8%) Ethnicity Non White 27037 (5.4%) 795 (1.2%) 26242 (6.1%) White 475424 (94.6%) 68160 (98.8%) 407264 (93.9%) We can plot the observed probability. jpeg(&quot;img/plot_12_quali.jpeg&quot;, width = 800, height = &quot;500&quot;) mydata %&gt;% group_by(strata) %&gt;% mutate(tot = n()) %&gt;% ungroup() %&gt;% group_by(strata,Urban) %&gt;% mutate(value = n()/tot) %&gt;% filter(Urban == &quot;Urban&quot;) %&gt;% ggplot(aes(x = fct_reorder(strata,value,.fun=&#39;median&#39;), y =value)) + geom_point() + labs(x = &quot;Stratas&quot;, y = &quot;Living in an Urban area&quot;, title = &quot;Observed percentage by stratas&quot;) + theme(axis.text.x = element_text(angle = 45, vjust=1, hjust=1)) dev.off() ## png ## 2 3.2 The null model (only strata) The null model allows us to estimate the IntraClass correlation (ICC), also known as the Variance Partition Coefficient (VPC), that is the part of the outcome variance that can be explained by the strata. # multilevel model m_null &lt;- glmmTMB(Urban ~ 1 + (1 | strata), data = mydata, family = binomial) # intercept varies according to the stratum jpeg(&quot;img/models_1.jpeg&quot;, width = 800, height = &quot;500&quot;) sjPlot::plot_model(m_null, type = &quot;diag&quot;) ## $strata dev.off() ## png ## 2 Outputs of the models: summary(m_null) ## Family: binomial ( logit ) ## Formula: Urban ~ 1 + (1 | strata) ## Data: mydata ## ## AIC BIC logLik deviance df.resid ## 397586.0 397608.3 -198791.0 397582.0 502459 ## ## Random effects: ## ## Conditional model: ## Groups Name Variance Std.Dev. ## strata (Intercept) 0.7121 0.8439 ## Number of obs: 502461, groups: strata, 12 ## ## Conditional model: ## Estimate Std. Error z value Pr(&gt;|z|) ## (Intercept) 2.6448 0.2443 10.82 &lt;2e-16 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 # get the variances: v_null &lt;- get_variance(m_null) # between stratas variance: v_null$var.random ## [1] 0.7121063 # intraclass correlation ICC_intersect &lt;- round(icc(m_null)$ICC_unadjusted*100, 2) ICC_intersect ## [1] 17.79 Plot of the predicted values by strata: #plot predictions &lt;- predict_response( m_null, c(&quot;strata&quot;), type = &quot;random&quot;) predictions &lt;- predictions %&gt;% arrange(predicted) predictions$rown = rownames(predictions) predictions$x_lab &lt;- paste0(predictions$rown,&quot;.&quot;,predictions$x) predictions$sex &lt;- as.factor(ifelse(grepl(&quot;Men&quot;, predictions$x), &quot;Men&quot;, &quot;Women&quot;)) predictions$ethnicity &lt;- as.factor(ifelse(grepl(&quot;Non White&quot;, predictions$x), &quot;Non white&quot;, &quot;White&quot;)) predictions$age &lt;- as.factor(ifelse(grepl(&quot;61+&quot;, df$x), &quot;61+&quot;, ifelse(grepl(&quot;-50&quot;, df$x), &quot;-50&quot;,&quot;51-60&quot;))) jpeg(&quot;img/plot.jpeg&quot;, width = 800, height = &quot;500&quot;) print(predictions %&gt;% ggplot(aes(x=predicted, y=fct_reorder(x,predicted,.fun=&#39;median&#39;), color = sex, linetype = ethnicity))+ geom_point(size=3) + geom_linerange(aes(xmin = conf.low, xmax = conf.high, size = age))+ labs( y = &quot;Sratas&quot;, x = &quot;&quot;, color = &quot;Sex Category&quot;, linetype = &quot;Ethnicity&quot;, size = &quot;Age&quot;, title = paste(&quot;Predicted values for living in a urban area&quot;))+ theme(axis.title = element_text(size = 10), axis.text=element_text(size=10)))+ scale_size_discrete(range = c(0.5, 1.5)) dev.off() ## png ## 2 3.3 The variance change To calculate the (additive) contribution of each category to the total variance, we can estimate the variance change when adjusting for this category. The Proportional Variance Change (PVC) when adjusting for all categories is the portion of ICC/VPC explained by additive effect. Therefore 100% - PVC is the part explained by an intersectional effect . # models where we add each category one by one m_gender &lt;- glmmTMB(Urban ~ Sex + (1 | strata), data = mydata, family=binomial) m_ethnicity &lt;- glmmTMB(Urban ~ Ethnicity + (1 | strata), data = mydata, family=binomial) m_age &lt;- glmmTMB(Urban ~ Age_class + (1 | strata), data = mydata, family=binomial) m_full &lt;- glmmTMB(Urban ~ Age_class + Ethnicity + Sex + (1 | strata), data = mydata, family=binomial) v_gender &lt;- get_variance(m_gender) v_ethnicity &lt;- get_variance(m_ethnicity) v_age &lt;- get_variance(m_age) v_full &lt;- get_variance(m_full) prop_gender &lt;- round(((v_null$var.random - v_gender$var.random) / v_null$var.random)*100,2) prop_gender &lt;- ifelse(is.null(prop_gender), 0, prop_gender) prop_ethnicity &lt;- round(((v_null$var.random - v_ethnicity$var.random) / v_null$var.random)*100,2) prop_ethnicity &lt;- ifelse(is.null(prop_ethnicity), 0, prop_ethnicity) prop_age &lt;- round(((v_null$var.random - v_age$var.random) / v_null$var.random)*100,2) prop_age &lt;- ifelse(is.null(prop_age), 0, prop_age) prop_full &lt;- round(((v_null$var.random - v_full$var.random) / v_null$var.random)*100,2) prop_full &lt;- ifelse(is.null(prop_full), 100, prop_full) prop_intersection &lt;- round(100 - prop_full,2) print( as.data.frame( cbind( parameters = c(&quot;ICC/VPC&quot;, &quot;% Sex category&quot;, &quot;% Age/generation&quot;, &quot;% Ethnicity&quot;, &quot;%Intersection&quot;), values = c(ICC_intersect,prop_gender, prop_age, prop_ethnicity,prop_intersection ) ))) ## parameters values ## 1 ICC/VPC 17.79 ## 2 % Sex category 0.06 ## 3 % Age/generation 1.12 ## 4 % Ethnicity 98.74 ## 5 %Intersection 0.03 ICC is 17.79%, which is high. These differences is almost totally explained by ethnicity (98.74%). "],["simple-example---continous-outcome.html", "4 Simple example - continous outcome 4.1 Description 4.2 The null model (only strata) 4.3 The variance change", " 4 Simple example - continous outcome As a working example, we want to explore intersectional inequalities in education length (a “late” intersectional strata) by early intersectional strata (12 stratas). 4.1 Description table1::table1(~ Sex + Age_class + Ethnicity | Education, data=mydata, row_wise = TRUE, overall=c(left=&quot;Total&quot;), caption=&quot;Description by age of education end&quot;) Description by age of education end Total(N=502461) Short Educ.(N=284626) Long Educ.(N=217835) Sex Women 273354 (54.4%) 153360 (53.9%) 119994 (55.1%) Men 229107 (45.6%) 131266 (46.1%) 97841 (44.9%) Age_class -50 132145 (26.3%) 63840 (22.4%) 68305 (31.4%) 51-60 177222 (35.3%) 96423 (33.9%) 80799 (37.1%) 61+ 193094 (38.4%) 124363 (43.7%) 68731 (31.6%) Ethnicity Non White 27037 (5.4%) 10917 (3.8%) 16120 (7.4%) White 475424 (94.6%) 273709 (96.2%) 201715 (92.6%) We can plot the observed means by strata. jpeg(&quot;img/plot_12_quanti.jpeg&quot;, width = 800, height = &quot;500&quot;) mydata %&gt;% group_by(strata) %&gt;% mutate(value = mean(AgeEducEnd)) %&gt;% ggplot(aes(x = fct_reorder(strata,value,.fun=&#39;median&#39;), y =value)) + geom_point() + labs(x = &quot;Stratas&quot;, y = &quot;Age of Education End&quot;, title = &quot;Observed means by stratas&quot;) + theme(axis.text.x = element_text(angle = 45, vjust=1, hjust=1)) dev.off() ## png ## 2 4.2 The null model (only strata) The null model allows us to estimate the IntraClass correlation (ICC), also known as the Variance Partition Coefficient (VPC), that is the part of the outcome variance that can be explained by the strata. # multilevel model m_null &lt;- glmmTMB(AgeEducEnd ~ 1 + (1 | strata), data = mydata) Outputs of the models: summary(m_null) ## Family: gaussian ( identity ) ## Formula: AgeEducEnd ~ 1 + (1 | strata) ## Data: mydata ## ## AIC BIC logLik deviance df.resid ## 2101612 2101645 -1050803 2101606 502458 ## ## Random effects: ## ## Conditional model: ## Groups Name Variance Std.Dev. ## strata (Intercept) 0.2157 0.4645 ## Residual 3.8366 1.9587 ## Number of obs: 502461, groups: strata, 12 ## ## Dispersion estimate for gaussian family (sigma^2): 3.84 ## ## Conditional model: ## Estimate Std. Error z value Pr(&gt;|z|) ## (Intercept) 17.1696 0.1342 127.9 &lt;2e-16 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 # get the variances: v_null &lt;- get_variance(m_null) # between stratas variance: v_null$var.random ## [1] 0.2157245 # intraclass correlation ICC_intersect &lt;- round(icc(m_null)$ICC_unadjusted*100, 2) ICC_intersect ## [1] 5.32 Plot of the predicted values by strata: #plot predictions &lt;- predict_response( m_null, c(&quot;strata&quot;), type = &quot;random&quot;) predictions &lt;- predictions %&gt;% arrange(predicted) predictions$rown = rownames(predictions) predictions$x_lab &lt;- paste0(predictions$rown,&quot;.&quot;,predictions$x) predictions$sex &lt;- as.factor(ifelse(grepl(&quot;Men&quot;, predictions$x), &quot;Men&quot;, &quot;Women&quot;)) predictions$ethnicity &lt;- as.factor(ifelse(grepl(&quot;Non White&quot;, predictions$x), &quot;Non white&quot;, &quot;White&quot;)) predictions$age &lt;- as.factor(ifelse(grepl(&quot;61+&quot;, df$x), &quot;61+&quot;, ifelse(grepl(&quot;-50&quot;, df$x), &quot;-50&quot;,&quot;51-60&quot;))) jpeg(&quot;img/plot_quanti.jpeg&quot;, width = 800, height = &quot;500&quot;) print(predictions %&gt;% ggplot(aes(x=predicted, y=fct_reorder(x,predicted,.fun=&#39;median&#39;), color = sex, linetype = ethnicity))+ geom_point(size=3) + geom_linerange(aes(xmin = conf.low, xmax = conf.high, size = age))+ labs( y = &quot;Sratas&quot;, x = &quot;&quot;, color = &quot;Sex Category&quot;, linetype = &quot;Ethnicity&quot;, size = &quot;Age&quot;, title = paste(&quot;Predicted values for Age of Education End&quot;))+ theme(axis.title = element_text(size = 10), axis.text=element_text(size=10)))+ scale_size_discrete(range = c(0.5, 1.5)) dev.off() ## png ## 2 4.3 The variance change To calculate the (additive) contribution of each category to the total variance, we can estimate the variance change when adjusting for this category. The Proportional Variance Change (PVC) when adjusting for all categories is the portion of ICC/VPC explained by additive effect. Therefore 100% - PVC is the part explained by an intersectional effect . # models where we add each category one by one m_gender &lt;- glmmTMB(AgeEducEnd ~ Sex + (1 | strata), data = mydata) m_ethnicity &lt;- glmmTMB(AgeEducEnd ~ Ethnicity + (1 | strata), data = mydata) m_age &lt;- glmmTMB(AgeEducEnd ~ Age_class + (1 | strata), data = mydata) m_full &lt;- glmmTMB(AgeEducEnd ~ Age_class + Ethnicity + Sex + (1 | strata), data = mydata) v_gender &lt;- get_variance(m_gender) v_ethnicity &lt;- get_variance(m_ethnicity) v_age &lt;- get_variance(m_age) v_full &lt;- get_variance(m_full) prop_gender &lt;- round(((v_null$var.random - v_gender$var.random) / v_null$var.random)*100,2) prop_gender &lt;- ifelse(is.null(prop_gender), 0, prop_gender) prop_ethnicity &lt;- round(((v_null$var.random - v_ethnicity$var.random) / v_null$var.random)*100,2) prop_ethnicity &lt;- ifelse(is.null(prop_ethnicity), 0, prop_ethnicity) prop_age &lt;- round(((v_null$var.random - v_age$var.random) / v_null$var.random)*100,2) prop_age &lt;- ifelse(is.null(prop_age), 0, prop_age) prop_full &lt;- round(((v_null$var.random - v_full$var.random) / v_null$var.random)*100,2) prop_full &lt;- ifelse(is.null(prop_full), 100, prop_full) prop_intersection &lt;- round(100 - prop_full,2) print( as.data.frame( cbind( parameters = c(&quot;ICC/VPC&quot;, &quot;% Sex category&quot;, &quot;% Age/generation&quot;, &quot;% Ethnicity&quot;, &quot;%Intersection&quot;), values = c(ICC_intersect,prop_gender, prop_age, prop_ethnicity,prop_intersection ) ))) ## parameters values ## 1 ICC/VPC 5.32 ## 2 % Sex category 2.59 ## 3 % Age/generation 9.55 ## 4 % Ethnicity 81.07 ## 5 %Intersection 6.62 ICC is 5.32%, which is moderate. This differences is mainly explained by ethnicity (81.07%), and, to a lesser extend, age (9.55%) and an intersectional effect (6.62%). "],["more-complexe-example---binary-outcome.html", "5 More complexe example - binary outcome 5.1 Description 5.2 The null model (only strata) 5.3 The variance change", " 5 More complexe example - binary outcome As a working example, we want to explore intersectional inequalities in alcohol consumption by intersectional strata (48 stratas). 5.1 Description We can start by describe the outcome by strata. table1::table1(~ Sex + Age_class + Ethnicity + Education + Urban | AlcDaily, data=mydata, row_wise = TRUE, overall=c(left=&quot;Total&quot;), caption=&quot;Description by: Daily (or almost) alcohol consumption&quot;) Description by: Daily (or almost) alcohol consumption Total(N=502461) No(N=400687) Yes(N=101774) Sex Women 273354 (54.4%) 229491 (57.3%) 43863 (43.1%) Men 229107 (45.6%) 171196 (42.7%) 57911 (56.9%) Age_class -50 132145 (26.3%) 111893 (27.9%) 20252 (19.9%) 51-60 177222 (35.3%) 140862 (35.2%) 36360 (35.7%) 61+ 193094 (38.4%) 147932 (36.9%) 45162 (44.4%) Ethnicity Non White 27037 (5.4%) 24979 (6.2%) 2058 (2.0%) White 475424 (94.6%) 375708 (93.8%) 99716 (98.0%) Education Short Educ. 284626 (56.6%) 231583 (57.8%) 53043 (52.1%) Long Educ. 217835 (43.4%) 169104 (42.2%) 48731 (47.9%) Urban Rural 68955 (13.7%) 51738 (12.9%) 17217 (16.9%) Urban 433506 (86.3%) 348949 (87.1%) 84557 (83.1%) We can plot the observed probability. jpeg(&quot;img/plot_12_quali_2.jpeg&quot;, width = 800, height = &quot;500&quot;) mydata %&gt;% group_by(strata_2) %&gt;% mutate(tot = n()) %&gt;% ungroup() %&gt;% group_by(strata_2,AlcDaily) %&gt;% mutate(value = n()/tot) %&gt;% filter(AlcDaily == &quot;Yes&quot;) %&gt;% ggplot(aes(x = fct_reorder(strata_2,value,.fun=&#39;median&#39;), y =value)) + geom_point() + labs(x = &quot;Stratas&quot;, y = &quot;Daily alcohol consumption&quot;, title = &quot;Observed percentage by stratas&quot;) + theme(axis.text.x = element_text(angle = 45, vjust=1, hjust=1)) dev.off() ## png ## 2 5.2 The null model (only strata) The null model allows us to estimate the IntraClass correlation (ICC), also known as the Variance Partition Coefficient (VPC), that is the part of the outcome variance that can be explained by the strata. # multilevel model m_null &lt;- glmmTMB(AlcDaily ~ 1 + (1 | strata_2), data = mydata, family = binomial) # intercept varies according to the stratum jpeg(&quot;img/models_1_2.jpeg&quot;, width = 800, height = &quot;500&quot;) sjPlot::plot_model(m_null, type = &quot;diag&quot;) ## $strata_2 dev.off() ## png ## 2 Outputs of the models: summary(m_null) ## Family: binomial ( logit ) ## Formula: AlcDaily ~ 1 + (1 | strata_2) ## Data: mydata ## ## AIC BIC logLik deviance df.resid ## 490939.7 490962.0 -245467.9 490935.7 502459 ## ## Random effects: ## ## Conditional model: ## Groups Name Variance Std.Dev. ## strata_2 (Intercept) 0.4638 0.6811 ## Number of obs: 502461, groups: strata_2, 48 ## ## Conditional model: ## Estimate Std. Error z value Pr(&gt;|z|) ## (Intercept) -1.7295 0.1018 -16.99 &lt;2e-16 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 # get the variances: v_null &lt;- get_variance(m_null) # between stratas variance: v_null$var.random ## [1] 0.4638349 # intraclass correlation ICC_intersect &lt;- round(icc(m_null)$ICC_unadjusted*100, 2) ICC_intersect ## [1] 12.36 Plot of the predicted values by strata: #plot predictions &lt;- predict_response( m_null, c(&quot;strata_2&quot;), type = &quot;random&quot;) predictions &lt;- predictions %&gt;% arrange(predicted) predictions$rown = rownames(predictions) predictions$x_lab &lt;- paste0(predictions$rown,&quot;.&quot;,predictions$x) predictions$sex &lt;- as.factor(ifelse(grepl(&quot;Men&quot;, predictions$x), &quot;Men&quot;, &quot;Women&quot;)) predictions$ethnicity &lt;- as.factor(ifelse(grepl(&quot;Non White&quot;, predictions$x), &quot;Non white&quot;, &quot;White&quot;)) predictions$age &lt;- as.factor(ifelse(grepl(&quot;61+&quot;, df$x), &quot;61+&quot;, ifelse(grepl(&quot;-50&quot;, df$x), &quot;-50&quot;,&quot;51-60&quot;))) predictions$Education &lt;- as.factor(ifelse(grepl(&quot;Short&quot;, predictions$x), &quot;Short&quot;, &quot;Long&quot;)) predictions$localarea &lt;- as.factor(ifelse(grepl(&quot;Urban&quot;, predictions$x), &quot;Urban&quot;, &quot;Rural&quot;)) jpeg(&quot;img/plot_2.jpeg&quot;, width = 800, height = &quot;500&quot;) print(predictions %&gt;% ggplot(aes(x=predicted, y=fct_reorder(x,predicted,.fun=&#39;median&#39;), color = sex, linetype = ethnicity))+ geom_point(aes(shape = Education, alpha = localarea),size=3) + geom_linerange(aes(xmin = conf.low, xmax = conf.high, size = age)) + labs(y = &quot;Sratas&quot;, x = &quot;&quot;, shape = &quot;Education&quot;, alpha = &quot;Life place&quot;, size = &quot;Age class&quot;, color = &quot;Sex category&quot;, linetype = &quot;Ethnicity&quot;, title = &quot;Predicted values for daily alcohol consumption&quot;) + theme(axis.title = element_text(size = 10)) + scale_size_discrete(range = c(0.5, 1.5)) + scale_alpha_discrete(range = c(0.5, 1))) dev.off() ## png ## 2 5.3 The variance change To calculate the (additive) contribution of each category to the total variance, we can estimate the variance change when adjusting for this category. The Proportional Variance Change (PVC) when adjusting for all categories is the portion of ICC/VPC explained by additive effect. Therefore 100% - PVC is the part explained by an intersectional effect . # models where we add each category one by one m_gender &lt;- glmmTMB(AlcDaily ~ Sex + (1 | strata_2), data = mydata, family=binomial) m_ethnicity &lt;- glmmTMB(AlcDaily ~ Ethnicity + (1 | strata_2), data = mydata, family=binomial) m_age &lt;- glmmTMB(AlcDaily ~ Age_class + (1 | strata_2), data = mydata, family=binomial) m_urban &lt;- glmmTMB(AlcDaily ~ Urban + (1 | strata_2), data = mydata, family=binomial) m_qualif &lt;- glmmTMB(AlcDaily ~ Education + (1 | strata_2), data = mydata, family=binomial) m_full &lt;- glmmTMB(AlcDaily ~ Age_class + Ethnicity + Sex + Urban + Education + (1 | strata_2), data = mydata, family=binomial) v_gender &lt;- get_variance(m_gender) v_ethnicity &lt;- get_variance(m_ethnicity) v_age &lt;- get_variance(m_age) v_urban &lt;- get_variance(m_urban) v_qualif &lt;- get_variance(m_qualif) v_full &lt;- get_variance(m_full) prop_gender &lt;- round(((v_null$var.random - v_gender$var.random) / v_null$var.random)*100,2) prop_gender &lt;- ifelse(is.null(prop_gender), 0, prop_gender) prop_ethnicity &lt;- round(((v_null$var.random - v_ethnicity$var.random) / v_null$var.random)*100,2) prop_ethnicity &lt;- ifelse(is.null(prop_ethnicity), 0, prop_ethnicity) prop_age &lt;- round(((v_null$var.random - v_age$var.random) / v_null$var.random)*100,2) prop_age &lt;- ifelse(is.null(prop_age), 0, prop_age) prop_qualif &lt;- round(((v_null$var.random - v_qualif$var.random) / v_null$var.random)*100,2) prop_qualif &lt;- ifelse(is.null(prop_qualif), 0, prop_qualif) prop_urban &lt;- round(((v_null$var.random - v_urban$var.random) / v_null$var.random)*100,2) prop_urban &lt;- ifelse(is.null(prop_urban), 0, prop_urban) prop_full &lt;- round(((v_null$var.random - v_full$var.random) / v_null$var.random)*100,2) prop_full &lt;- ifelse(is.null(prop_full), 100, prop_full) prop_intersection &lt;- round(100 - prop_full,2) print( as.data.frame( cbind( parameters = c(&quot;ICC/VPC&quot;, &quot;% Sex category&quot;, &quot;% Age/generation&quot;, &quot;% Ethnicity&quot;, &quot;% Life Place&quot;, &quot;% Education&quot;, &quot;%Intersection&quot;), values = c(ICC_intersect,prop_gender, prop_age, prop_ethnicity, prop_urban,prop_qualif, prop_intersection ) ))) ## parameters values ## 1 ICC/VPC 12.36 ## 2 % Sex category 20.07 ## 3 % Age/generation 6.62 ## 4 % Ethnicity 55.45 ## 5 % Life Place 15.46 ## 6 % Education 2.3 ## 7 %Intersection 5.02 ICC is 12.36%, which is moderate. This differences is mainly explained by ethnicity (55.45%), sex category (20.07%) and life place (15.46%). "],["more-complexe-example---quantitative-outcome.html", "6 More complexe example - quantitative outcome 6.1 Description 6.2 The null model (only strata) 6.3 The variance change", " 6 More complexe example - quantitative outcome As a working example, we want to explore intersectional inequalities in air pollution exposition by intersectional strata (48 stratas). 6.1 Description We can start by describe the outcome by strata. mydata$AirPoll_PM10d_class &lt;- as.factor(ifelse(mydata$AirPoll_PM10 &lt; mean(mydata$AirPoll_PM10), &quot;Below mean&quot;, &quot;Above mean&quot;)) table1::table1(~ Sex + Age_class + Ethnicity + Education + Urban | AirPoll_PM10d_class, row_wise = TRUE, data=mydata, overall=c(left=&quot;Total&quot;), caption=&quot;Description by air pollution&quot;) Description by air pollution Total(N=502461) Above mean(N=219479) Below mean(N=282982) Sex Women 273354 (54.4%) 119666 (54.5%) 153688 (54.3%) Men 229107 (45.6%) 99813 (45.5%) 129294 (45.7%) Age_class -50 132145 (26.3%) 60656 (27.6%) 71489 (25.3%) 51-60 177222 (35.3%) 76931 (35.1%) 100291 (35.4%) 61+ 193094 (38.4%) 81892 (37.3%) 111202 (39.3%) Ethnicity Non White 27037 (5.4%) 17586 (8.0%) 9451 (3.3%) White 475424 (94.6%) 201893 (92.0%) 273531 (96.7%) Education Short Educ. 284626 (56.6%) 123781 (56.4%) 160845 (56.8%) Long Educ. 217835 (43.4%) 95698 (43.6%) 122137 (43.2%) Urban Rural 68955 (13.7%) 16933 (7.7%) 52022 (18.4%) Urban 433506 (86.3%) 202546 (92.3%) 230960 (81.6%) We can plot the observed means by strata. jpeg(&quot;img/plot_12_quanti_2.jpeg&quot;, width = 800, height = &quot;500&quot;) mydata %&gt;% group_by(strata_2) %&gt;% mutate(value = mean(AirPoll_PM10)) %&gt;% ggplot(aes(x = fct_reorder(strata_2,value,.fun=&#39;median&#39;), y =value)) + geom_point() + labs(x = &quot;Stratas&quot;, y = &quot;Air pollution (pm 10)&quot;, title = &quot;Observed means by stratas&quot;) + theme(axis.text.x = element_text(angle = 45, vjust=1, hjust=1)) dev.off() ## png ## 2 6.2 The null model (only strata) The null model allows us to estimate the IntraClass correlation (ICC), also known as the Variance Partition Coefficient (VPC), that is the part of the outcome variance that can be explained by the strata. # multilevel model m_null &lt;- glmmTMB(AirPoll_PM10 ~ 1 + (1 | strata_2), data = mydata) Outputs of the models: summary(m_null) ## Family: gaussian ( identity ) ## Formula: AirPoll_PM10 ~ 1 + (1 | strata_2) ## Data: mydata ## ## AIC BIC logLik deviance df.resid ## 2012853 2012886 -1006424 2012847 502458 ## ## Random effects: ## ## Conditional model: ## Groups Name Variance Std.Dev. ## strata_2 (Intercept) 0.6956 0.834 ## Residual 3.2140 1.793 ## Number of obs: 502461, groups: strata_2, 48 ## ## Dispersion estimate for gaussian family (sigma^2): 3.21 ## ## Conditional model: ## Estimate Std. Error z value Pr(&gt;|z|) ## (Intercept) 15.9324 0.1216 131 &lt;2e-16 *** ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 # get the variances: v_null &lt;- get_variance(m_null) # between stratas variance: v_null$var.random ## [1] 0.6956251 # intraclass correlation ICC_intersect &lt;- round(icc(m_null)$ICC_unadjusted*100, 2) ICC_intersect ## [1] 17.79 Plot of the predicted values by strata: #plot predictions &lt;- predict_response( m_null, c(&quot;strata_2&quot;), type = &quot;random&quot;) predictions &lt;- predictions %&gt;% arrange(predicted) predictions$rown = rownames(predictions) predictions$x_lab &lt;- paste0(predictions$rown,&quot;.&quot;,predictions$x) predictions$sex &lt;- as.factor(ifelse(grepl(&quot;Men&quot;, predictions$x), &quot;Men&quot;, &quot;Women&quot;)) predictions$ethnicity &lt;- as.factor(ifelse(grepl(&quot;Non White&quot;, predictions$x), &quot;Non white&quot;, &quot;White&quot;)) predictions$age &lt;- as.factor(ifelse(grepl(&quot;61+&quot;, df$x), &quot;61+&quot;, ifelse(grepl(&quot;-50&quot;, df$x), &quot;-50&quot;,&quot;51-60&quot;))) predictions$Education &lt;- as.factor(ifelse(grepl(&quot;Short&quot;, predictions$x), &quot;Short&quot;, &quot;Long&quot;)) predictions$localarea &lt;- as.factor(ifelse(grepl(&quot;Urban&quot;, predictions$x), &quot;Urban&quot;, &quot;Rural&quot;)) jpeg(&quot;img/plot_quanti_2.jpeg&quot;, width = 800, height = &quot;500&quot;) print(predictions %&gt;% ggplot(aes(x=predicted, y=fct_reorder(x,predicted,.fun=&#39;median&#39;), color = sex, linetype = ethnicity))+ geom_point(aes(shape = Education, alpha = localarea),size=3) + geom_linerange(aes(xmin = conf.low, xmax = conf.high, size = age)) + labs(y = &quot;Sratas&quot;, x = &quot;&quot;, shape = &quot;Education&quot;, alpha = &quot;Life place&quot;, size = &quot;Age class&quot;, color = &quot;Sex category&quot;, linetype = &quot;Ethnicity&quot;, title = &quot;Predicted values for air pollution (pm10)&quot;) + theme(axis.title = element_text(size = 10)) + scale_size_discrete(range = c(0.5, 1.5)) + scale_alpha_discrete(range = c(0.5, 1))) dev.off() ## png ## 2 6.3 The variance change To calculate the (additive) contribution of each category to the total variance, we can estimate the variance change when adjusting for this category. The Proportional Variance Change (PVC) when adjusting for all categories is the portion of ICC/VPC explained by additive effect. Therefore 100% - PVC is the part explained by an intersectional effect . # models where we add each category one by one m_gender &lt;- glmmTMB(AirPoll_PM10 ~ Sex + (1 | strata_2), data = mydata) m_ethnicity &lt;- glmmTMB(AirPoll_PM10 ~ Ethnicity + (1 | strata_2), data = mydata) m_age &lt;- glmmTMB(AirPoll_PM10 ~ Age_class + (1 | strata_2), data = mydata) m_urban &lt;- glmmTMB(AirPoll_PM10 ~ Urban + (1 | strata_2), data = mydata) m_qualif &lt;- glmmTMB(AirPoll_PM10 ~ Education + (1 | strata_2), data = mydata) m_full &lt;- glmmTMB(AirPoll_PM10 ~ Age_class + Ethnicity + Sex + Urban + Education + (1 | strata_2), data = mydata) v_gender &lt;- get_variance(m_gender) v_ethnicity &lt;- get_variance(m_ethnicity) v_age &lt;- get_variance(m_age) v_urban &lt;- get_variance(m_urban) v_qualif &lt;- get_variance(m_qualif) v_full &lt;- get_variance(m_full) prop_gender &lt;- round(((v_null$var.random - v_gender$var.random) / v_null$var.random)*100,2) prop_gender &lt;- ifelse(is.null(prop_gender), 0, prop_gender) prop_ethnicity &lt;- round(((v_null$var.random - v_ethnicity$var.random) / v_null$var.random)*100,2) prop_ethnicity &lt;- ifelse(is.null(prop_ethnicity), 0, prop_ethnicity) prop_age &lt;- round(((v_null$var.random - v_age$var.random) / v_null$var.random)*100,2) prop_age &lt;- ifelse(is.null(prop_age), 0, prop_age) prop_qualif &lt;- round(((v_null$var.random - v_qualif$var.random) / v_null$var.random)*100,2) prop_qualif &lt;- ifelse(is.null(prop_qualif), 0, prop_qualif) prop_urban &lt;- round(((v_null$var.random - v_urban$var.random) / v_null$var.random)*100,2) prop_urban &lt;- ifelse(is.null(prop_urban), 0, prop_urban) prop_full &lt;- round(((v_null$var.random - v_full$var.random) / v_null$var.random)*100,2) prop_full &lt;- ifelse(is.null(prop_full), 100, prop_full) prop_intersection &lt;- round(100 - prop_full,2) print( as.data.frame( cbind( parameters = c(&quot;ICC/VPC&quot;, &quot;% Sex category&quot;, &quot;% Age/generation&quot;, &quot;% Ethnicity&quot;, &quot;% Life Place&quot;, &quot;% Education&quot;, &quot;%Intersection&quot;), values = c(ICC_intersect,prop_gender, prop_age, prop_ethnicity, prop_urban,prop_qualif, prop_intersection ) ))) ## parameters values ## 1 ICC/VPC 17.79 ## 2 % Sex category 0.1 ## 3 % Age/generation 0.25 ## 4 % Ethnicity 8.65 ## 5 % Life Place 89.12 ## 6 % Education 0.44 ## 7 %Intersection 0.62 ICC is 17.79%, which is high This differences is mainly explained by life place (89.12%), but also, to a lesser extend, ethnicity (8.65%). "],["references.html", "References", " References "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
